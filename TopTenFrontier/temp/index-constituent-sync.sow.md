# SOW: IndexConstituentService - Constituent Sync & API

## 1. タスク概要
S&P 500 の構成銘柄から時価総額上位 10 銘柄を抽出し、REST API・イベント配信を提供するマイクロサービスを実装する。目的は 5 分以内に最新のトップ 10 を反映し、下流の MarketDataService/PortfolioManagementService が迅速に追従できる状態を作ること。完了条件は Design/OpenAPI/ImplPlan を満たす PR が作成され、テスト・契約検証を通過することである。

## 2. 設計パターンの検討
### 2.1 要点の整理
- 外部 API (Polygon 等) のレート制限と可用性に依存。
- トップ 10 は頻繁に変わらないが、変化時は速やかな通知が必要。
- 将来的なデータソース追加 (例: 別プロバイダ) に対応したい。
- イベント駆動で他サービスと疎結合に保つ。

### 2.2 候補パターン
1. **ポーリング + バッチ差分検出** (Cron + DB 差分)
2. **ストリーミング (Websocket) リスナー + 即時更新**
3. **プロバイダ Webhook 受信 + フォールバックポーリング**
4. **イベントソーシング + Snapshot 再構築**

### 2.3 比較
- (1) は実装容易・外部依存少・遅延 5 分単位。レート制限に合わせた制御がしやすい。
- (2) は低遅延だが Websocket 安定性・再接続が課題。Workers での常時接続コスト高。
- (3) は Webhook 提供するプロバイダが限定。冗長化には良いが初期スコープ外。
- (4) は履歴管理に強いが複雑度が高い。現在の要件 (Top10 のみ) では過剰。

### 2.4 最終決定
- **採用: パターン (1) ポーリング + バッチ差分検出**。理由: レート制限制御が容易で初期要件に最適。Durable Object で排他制御し、Queue 発行で疎結合な通知を実現できる。
- 将来の拡張として (3) Webhook を追加する前提でインターフェースを抽象化する。

## 3. 実装計画 (TDD ベース)
1. Prisma/RLS のスキーマ追加 (構造変更コミット)。
2. ハンドラ単体テスト → 実装 (Red/Green/Refactor) を順番に実施。
3. Durable Object の状態遷移テスト → 実装。
4. Queue 発行の契約テスト。
5. OpenAPI 契約テストと k6 レイテンシチェック。

## 4. ユーザー向けタスクリスト
- Polygon.io API キーを準備し、Cloudflare Workers のシークレット POLYGON_API_KEY に保存。
- 代替データソース (Alpha Vantage) のキーも取得して冗長化構成を可能にする。
- Supabase Auth で dmin ロールを持つユーザーを設定し、POST /sync テストに使用。

name: Issue to PR with Codex

on:
  workflow_dispatch: {}
  issues:
    types: [labeled]

permissions:
  contents: write          # push/branchä½œæˆã«å¿…è¦
  pull-requests: write     # PRã®ä½œæˆã«å¿…è¦
  issues: write            # â† è¿½åŠ 

jobs:
  fix_with_codex:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.label && github.event.label.name == 'codex') }} # æ‰‹å‹• or 'codex'ãƒ©ãƒ™ãƒ«æ™‚ã®ã¿å®Ÿè¡Œ

    permissions:
      contents: write
      pull-requests: write
      issues: write    # â† read ã§ã¯ãªã write ã«
      # actions: write ã¯ä¸è¦ãªã‚‰å¤–ã—ã¦OK

    steps:
      - uses: actions/checkout@v4
        with:
          # ãƒ•ãƒ«ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã‚’å–å¾—ã—ã¦ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’ç¢ºå®Ÿã«ã™ã‚‹
          fetch-depth: 0

      - name: Debug event context
        run: |
          set -euo pipefail
          echo "EVENT_NAME=${GITHUB_EVENT_NAME}"
          echo "EVENT_PATH=${GITHUB_EVENT_PATH}"
          echo "Label in payload (first occurrence):"
          grep -m1 '"label"\|"name"' "$GITHUB_EVENT_PATH" || true

      - name: Set git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: |
          set -euo pipefail
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 2
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 120000
          retry() { n=0; until [ $n -ge 5 ]; do "$@" && break; n=$((n+1)); echo "npm retry $n"; sleep $((n*5)); done; }
          retry npm ci --no-audit --no-fund

      - name: Install Codex CLI
        run: |
          set -euo pipefail
          # OpenAI Codex CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€æ–°ç‰ˆã‚’ä½¿ç”¨ï¼‰ with retries
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 2
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 120000
          retry() { n=0; until [ $n -ge 5 ]; do npm install -g @openai/codex && break; n=$((n+1)); echo "codex install retry $n"; sleep $((n*5)); done; }
          retry true

      - name: Preflight: Check OpenAI API key and reachability
        id: preflight
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Manual dispatch ã§ã¯ Issue æ–‡è„ˆãŒç„¡ã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "workflow_dispatch detected; skipping Codex execution (diagnostic run)"
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ISSUE_NUMBER="${{ github.event.issue.number }}"

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            : > preflight.md
            printf '%s\n' \
              'âš ï¸ OpenAI API key is not configured (secrets.OPENAI_API_KEY).' \
              '' \
              'ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® Secrets ã« OPENAI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚' \
              'è¨­å®šå¾Œã€Issue ã« `codex` ãƒ©ãƒ™ãƒ«ã‚’å†åº¦ä»˜ä¸ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚' \
              > preflight.md
            gh issue comment "${ISSUE_NUMBER}" --body-file preflight.md || true
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # List(models) ã¯ 200 ã§ã‚‚ã€ãƒ¢ãƒ‡ãƒ«æ¨©é™ãŒåˆ¥ã§è½ã¡ã‚‹å ´åˆãŒã‚ã‚‹
          echo 'Probing chat.completions with model=gpt-5-codex...'
          RESP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"model":"gpt-5-codex","messages":[{"role":"user","content":"ping"}],"max_tokens":1}' || true)
          echo "Probe HTTP code: $RESP_CODE"

          if [ "$RESP_CODE" != "200" ]; then
            : > preflight.md
            printf '%s\n' \
              'âš ï¸ OpenAI API èªè¨¼/æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆchat.completions ã§å¤±æ•—ï¼‰' \
              '' \
              "HTTP status: $RESP_CODE" \
              '' \
              '- APIã‚­ãƒ¼ãŒç„¡åŠ¹/æœŸé™åˆ‡ã‚Œ/æ¨©é™ä¸è¶³ã®å¯èƒ½æ€§' \
              '- çµ„ç¹”å´ã®ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨æ¨©é™ï¼ˆgpt-5-codexï¼‰æœªä»˜ä¸ã®å¯èƒ½æ€§' \
              'å¯¾å‡¦: OPENAI_API_KEY ã¨ãƒ¢ãƒ‡ãƒ«æ¨©é™ã‚’ç¢ºèªã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚' \
              > preflight.md
            gh issue comment "${ISSUE_NUMBER}" --body-file preflight.md || true
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_skip=false" >> "$GITHUB_OUTPUT"

      # ã“ã“ã‚’è¿½åŠ ï¼ä¸Šæ›¸ãï¼ˆèªè¨¼æ–¹å¼=APIã‚­ãƒ¼ã€ãƒ¢ãƒ‡ãƒ«=gpt-5-codexï¼‰
      - name: Configure Codex (API key mode)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          cat > ~/.codex/config.toml <<'TOML'
          preferred_auth_method = "apikey"
          model = "gpt-5-codex"
          model_reasoning_effort = "high"
          TOML

      - name: Generate patch with Codex
        if: steps.preflight.outputs.should_skip != 'true'
        id: codex_exec
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
        run: |
          set -euo pipefail
          unset OPENAI_BASE_URL || true  # èª¤ã£ãŸãƒ™ãƒ¼ã‚¹URLã‚’æ’é™¤

          git fetch --prune origin
          BASE=origin/main
          BRANCH="codex/issue-${{ github.event.issue.number }}"
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "Remote branch exists. Tracking and rebasing..."
            git switch -C "$BRANCH" --track "origin/$BRANCH"
            git pull --rebase origin "$BRANCH"
          else
            echo "Creating new branch from $BASE"
            git switch -c "$BRANCH" "$BASE"
          fi

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          PROMPT="$(printf '%s\n\n%s\n\n%s\n%s\n%s\n%s' \
            "$ISSUE_TITLE" \
            "$ISSUE_BODY" \
            "æœ€å¾Œã« 'npm run build && npm test' ã‚’å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚.git ç­‰ã®ãƒ‰ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚")"

          codex --version || true
          codex exec --full-auto --model gpt-5-codex --config preferred_auth_method=apikey "$PROMPT" < /dev/null

          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "feat: #${{ github.event.issue.number }} - $ISSUE_TITLE" \
                        -m "Automated implementation by Codex CLI based on issue requirements." \
                        -m "Closes #${{ github.event.issue.number }}"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to commit"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          # ãƒªãƒ¢ãƒ¼ãƒˆã¨ä¹–é›¢ãŒå‡ºã¦ã‚‚å®‰å…¨ã«æ›´æ–°
          git push --force-with-lease -u origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request (only if changes)
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="codex/issue-${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # fetch latest base
          git fetch origin main

          AHEAD=$(git rev-list --count origin/main..HEAD)
          if [ "$AHEAD" -eq 0 ]; then
            echo "No commits between origin/main and $BRANCH â€” skipping PR creation."

            # explain in issue
            : > issue-comment.md
            printf '%s\n' \
              'ğŸ¤– è‡ªå‹•å®Ÿè£…ã‚’è©¦è¡Œã—ã¾ã—ãŸãŒã€ãƒªãƒã‚¸ãƒˆãƒªã«å¤‰æ›´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' \
              '' \
              'Codex ã¯å¤‰æ›´ã‚’ç”Ÿæˆã—ãªã‹ã£ãŸãŸã‚ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚' \
              > issue-comment.md

            gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md
            # ensure no pr-url.txt is left over
            rm -f pr-url.txt || true
            exit 0
          fi

          # Create PR body file (ensure this file exists before calling gh pr create)
          : > pr-body.md
          printf '%s\n' \
            '## æ¦‚è¦' \
            "ã“ã®PRã¯ Issue #${ISSUE_NUMBER} ã®è‡ªå‹•å®Ÿè£…ã§ã™ã€‚" \
            '' \
            '## å¤‰æ›´å†…å®¹' \
            '- Codex CLI ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…' \
            '- TDDåŸå‰‡ã«åŸºã¥ãå®Ÿè£…' \
            '' \
            '## é–¢é€£Issue' \
            "Closes #${ISSUE_NUMBER}" \
            > pr-body.md

          PR_TITLE="feat: #${ISSUE_NUMBER} - ${ISSUE_TITLE}"

          # Create the PR (gh uses GH_TOKEN from env)
          gh pr create --title "$PR_TITLE" --body-file pr-body.md --base main --head "$BRANCH" --label "codex"

          # Get URL of the PR we just created (use gh pr view to query it)
          PR_URL=$(gh pr view --json url --jq '.url')
          echo "PR_URL=${PR_URL}" > pr-url.txt
          echo "Created PR: ${PR_URL}"

      - name: Add comment to issue
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH="codex/issue-${ISSUE_NUMBER}"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆheredocã‚’é¿ã‘ã¦printfã§ç”Ÿæˆï¼‰
          : > issue-comment.md
          printf '%s\n' \
            'ğŸ¤– **è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼**' \
            '' \
            'Codex CLIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚' \
            '' \
            "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${BRANCH}\`" \
            '- **å®Ÿè£…æ–¹é‡**: TDD + Tidy FirståŸå‰‡' \
            '- **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™' \
            '' \
            'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚' \
            > issue-comment.md
          
          gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md

      - name: Add comment to issue (no changes)
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          : > issue-comment.md
          printf '%s\n' \
            'ğŸ¤– è‡ªå‹•å®Ÿè£…ã‚’è©¦è¡Œã—ã¾ã—ãŸãŒã€ãƒªãƒã‚¸ãƒˆãƒªã«å¤‰æ›´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' \
            '' \
            'Codex ã¯å¤‰æ›´ã‚’ç”Ÿæˆã—ãªã‹ã£ãŸãŸã‚ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚' \
            > issue-comment.md
          gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md

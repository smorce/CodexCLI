name: Issue to PR with Codex

on:
  issues:
    types: [labeled]

permissions:
  contents: write          # push/branchä½œæˆã«å¿…è¦
  pull-requests: write     # PRã®ä½œæˆã«å¿…è¦

jobs:
  fix_with_codex:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'codex' # 'codex'ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸæ™‚ã®ã¿å®Ÿè¡Œ

    permissions:
      contents: write
      pull-requests: write
      actions: write
      issues: read

    steps:
      - uses: actions/checkout@v4
        with:
          # ãƒ•ãƒ«ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã‚’å–å¾—ã—ã¦ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’ç¢ºå®Ÿã«ã™ã‚‹
          fetch-depth: 0

      - name: Set git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Install Codex CLI
        run: |
          # OpenAI Codex CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€æ–°ç‰ˆã‚’ä½¿ç”¨ï¼‰
          npm install -g @openai/codex

      - name: Generate patch with Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
        run: |
          BRANCH="codex/issue-${{ github.event.issue.number }}"
          echo "Creating branch: $BRANCH"
          git switch -c "$BRANCH"

          # Issueæƒ…å ±ã‚’å–å¾—
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # TopTenFrontier ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
          PROMPT="$(printf '%s\n\n%s\n\n%s\n%s\n%s\n%s' \
            "$ISSUE_TITLE" \
            "$ISSUE_BODY" \
            "ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚" \
            "TDDï¼ˆRed-Green-Refactorï¼‰ã¨Tidy FirståŽŸå‰‡ã‚’åŽ³æ ¼ã«éµå®ˆã—ã¦ãã ã•ã„ã€‚" \
            "æ§‹é€ çš„å¤‰æ›´ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã¨æŒ¯ã‚‹èˆžã„ã®å¤‰æ›´ï¼ˆæ©Ÿèƒ½è¿½åŠ ï¼‰ã¯åˆ¥ã€…ã®ã‚³ãƒŸãƒƒãƒˆã«åˆ†é›¢ã—ã¦ãã ã•ã„ã€‚" \
            "æœ€å¾Œã« 'npm run build && npm test' ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚.gitã®ã‚ˆã†ãª'.'ã‹ã‚‰å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚")"
          
          echo "Preparing Codex config (reasoning=high)..."
          mkdir -p ~/.codex
          cat > ~/.codex/config.toml <<'TOML'
          model = "gpt-5"
          model_reasoning_effort = "high"
          TOML

          echo "Executing Codex with prompt..."
          # éžå¯¾è©±ç’°å¢ƒå‘ã‘ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          export CI=true
          export TERM=dumb

          # Codex CLIã‚’å®Ÿè¡Œï¼ˆãƒ•ãƒ«ã‚ªãƒ¼ãƒˆãƒ»éžå¯¾è©±ï¼‰
          codex exec --full-auto "$PROMPT" < /dev/null

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing..."
            git add .
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Issueæƒ…å ±ã‹ã‚‰ç”Ÿæˆ
            git commit -m "feat: #${{ github.event.issue.number }} - $ISSUE_TITLE" \
                       -m "Automated implementation by Codex CLI based on issue requirements." \
                       -m "Closes #${{ github.event.issue.number }}"
          else
            echo "No changes to commit"
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push -u origin "$BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="codex/issue-${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # PRã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’æ§‹ç¯‰
          PR_TITLE="feat: #${ISSUE_NUMBER} - ${ISSUE_TITLE}"
          
          # PRæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆheredocã‚’é¿ã‘ã¦printfã§ç”Ÿæˆï¼‰
          : > pr-body.md
          printf '%s\n' \
            '## æ¦‚è¦' \
            "ã“ã®PRã¯ Issue #${ISSUE_NUMBER} ã®è‡ªå‹•å®Ÿè£…ã§ã™ã€‚" \
            '' \
            '## å¤‰æ›´å†…å®¹' \
            '- Codex CLIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…' \
            '- TDDåŽŸå‰‡ã«åŸºã¥ãå®Ÿè£…' \
            '- OpenAPIä»•æ§˜æ›¸ã¨ã®æ•´åˆæ€§ç¢ºä¿' \
            '' \
            '## é–¢é€£Issue' \
            "Closes #${ISSUE_NUMBER}" \
            '' \
            '## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ' \
            '- [x] TDDï¼ˆRed-Green-Refactorï¼‰ã‚µã‚¤ã‚¯ãƒ«ã®éµå®ˆ' \
            '- [x] æ§‹é€ çš„å¤‰æ›´ã¨æŒ¯ã‚‹èˆžã„ã®å¤‰æ›´ã®åˆ†é›¢' \
            '- [x] ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œç¢ºèª' \
            '- [x] ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãªã—' \
            '' \
            '---' \
            '*ã“ã®PRã¯GitHub Actionsã¨Codex CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*' \
            > pr-body.md

          # PRã‚’ä½œæˆ
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr-body.md \
            --base main \
            --head "$BRANCH" \
            --label "codex"

          echo "Pull request created successfully"

      - name: Add comment to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH="codex/issue-${ISSUE_NUMBER}"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆheredocã‚’é¿ã‘ã¦printfã§ç”Ÿæˆï¼‰
          : > issue-comment.md
          printf '%s\n' \
            'ðŸ¤– **è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼**' \
            '' \
            'Codex CLIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚' \
            '' \
            "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${BRANCH}\`" \
            '- **å®Ÿè£…æ–¹é‡**: TDD + Tidy FirståŽŸå‰‡' \
            '- **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™' \
            '' \
            'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€å•é¡Œãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚' \
            > issue-comment.md
          
          gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md

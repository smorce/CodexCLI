name: Issue to PR with Codex

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Execute Codex for this issue number (required for manual run)'
        required: true
        type: string
  issues:
    types: [labeled]

permissions:
  contents: write          # push/branch作成に必要
  pull-requests: write     # PRの作成に必要
  issues: write            # ← 追加

jobs:
  fix_with_codex:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.label && github.event.label.name == 'codex') }} # 手動 or 'codex'ラベル時のみ実行

    permissions:
      contents: write
      pull-requests: write
      issues: write    # ← read ではなく write に
      # actions: write は不要なら外してOK

    env:
      # 利用するOpenAIモデル。リポジトリ/環境変数 vars.OPENAI_MODEL が未設定なら gpt-5-codex を使用
      OPENAI_MODEL: ${{ vars.OPENAI_MODEL != '' && vars.OPENAI_MODEL || 'gpt-5-codex' }}

    steps:
      - uses: actions/checkout@v4
        with:
          # フルヒストリーを取得してブランチ作成を確実にする
          fetch-depth: 0

      - name: Debug event context
        run: |
          set -euo pipefail
          echo "EVENT_NAME=${GITHUB_EVENT_NAME}"
          echo "EVENT_PATH=${GITHUB_EVENT_PATH}"
          echo "Label in payload (first occurrence):"
          grep -m1 '"label"\|"name"' "$GITHUB_EVENT_PATH" || true

      - name: Set git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: |
          set -euo pipefail
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 2
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 120000
          retry() { n=0; until [ $n -ge 5 ]; do "$@" && break; n=$((n+1)); echo "npm retry $n"; sleep $((n*5)); done; }
          retry npm ci --no-audit --no-fund

      - name: Install Codex CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # OpenAI Codex CLIをインストール（最新版を使用） with retries
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 2
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 120000
          retry() { n=0; until [ $n -ge 5 ]; do npm install -g @openai/codex && break; n=$((n+1)); echo "codex install retry $n"; sleep $((n*5)); done; }
          retry true

      - name: "Preflight: Check OpenAI API key, determine issue, and reachability"
        id: preflight
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          set -euo pipefail
          # Determine ISSUE_NUMBER for both triggers
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          echo "Target ISSUE_NUMBER=$ISSUE_NUMBER"


          # Fetch Issue title/body for downstream steps
          ISSUE_TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title' || true)
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body  --jq '.body'  || true)

          # Export outputs
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          {
            echo 'issue_title<<EOF'
            echo "$ISSUE_TITLE"
            echo 'EOF'
            echo 'issue_body<<EOF'
            echo "$ISSUE_BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          echo "should_skip=false" >> "$GITHUB_OUTPUT"

      # 認証方式を自動選択（CODEX_AUTH_JSON があれば chatgpt、無ければ apikey）
      - name: Configure Codex auth and model
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          if [ -n "${CODEX_AUTH_JSON:-}" ]; then
            printf '%s' "$CODEX_AUTH_JSON" > ~/.codex/auth.json
            chmod 600 ~/.codex/auth.json
            : > ~/.codex/config.toml
            printf '%s\n' \
              'preferred_auth_method = "chatgpt"' \
              "model = \"${OPENAI_MODEL}\"" \
              'model_reasoning_effort = "high"' \
              > ~/.codex/config.toml
          else
            : > ~/.codex/config.toml
            printf '%s\n' \
              'preferred_auth_method = "apikey"' \
              "model = \"${OPENAI_MODEL}\"" \
              'model_reasoning_effort = "high"' \
              > ~/.codex/config.toml
          fi

      - name: Generate patch with Codex
        if: steps.preflight.outputs.should_skip != 'true'
        id: codex_exec
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
        run: |
          set -euo pipefail
          unset OPENAI_BASE_URL || true  # 誤ったベースURLを排除

          git fetch --prune origin
          BASE=origin/main
          BRANCH="codex/issue-${{ steps.preflight.outputs.issue_number }}"
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "Remote branch exists. Tracking and rebasing..."
            git switch -C "$BRANCH" --track "origin/$BRANCH"
            git pull --rebase origin "$BRANCH"
          else
            echo "Creating new branch from $BASE"
            git switch -c "$BRANCH" "$BASE"
          fi

          ISSUE_TITLE="${{ steps.preflight.outputs.issue_title }}"
          ISSUE_BODY="${{ steps.preflight.outputs.issue_body }}"

          PROMPT="$(printf '%s\n\n%s\n\n%s\n' \
            "$ISSUE_TITLE" \
            "$ISSUE_BODY" \
            "最後に 'npm run build && npm test' を実行し、エラーが出ないことを確認してください。.git 等のドットファイル/フォルダは変更しないでください。")"

          codex --version || true
          codex exec --full-auto --model "${OPENAI_MODEL}" "$PROMPT" < /dev/null
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "feat: #${{ steps.preflight.outputs.issue_number }} - $ISSUE_TITLE" \
                        -m "Automated implementation by Codex CLI based on issue requirements." \
                         -m "Closes #${{ steps.preflight.outputs.issue_number }}"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to commit"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          # リモートと乖離が出ても安全に更新
          git push --force-with-lease -u origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request (only if changes)
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="codex/issue-${{ steps.preflight.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.preflight.outputs.issue_title }}"
          ISSUE_NUMBER="${{ steps.preflight.outputs.issue_number }}"

          # fetch latest base
          git fetch origin main

          AHEAD=$(git rev-list --count origin/main..HEAD)
          if [ "$AHEAD" -eq 0 ]; then
            echo "No commits between origin/main and $BRANCH — skipping PR creation."

            # explain in issue
            : > issue-comment.md
            printf '%s\n' \
              '🤖 自動実装を試行しましたが、リポジトリに変更は見つかりませんでした。' \
              '' \
              'Codex は変更を生成しなかったため、プルリクエストは作成されませんでした。' \
              > issue-comment.md

            gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md
            # ensure no pr-url.txt is left over
            rm -f pr-url.txt || true
            exit 0
          fi

          # Create PR body file (ensure this file exists before calling gh pr create)
          : > pr-body.md
          printf '%s\n' \
            '## 概要' \
            "このPRは Issue #${ISSUE_NUMBER} の自動実装です。" \
            '' \
            '## 変更内容' \
            '- Codex CLI による自動実装' \
            '- TDD原則に基づく実装' \
            '' \
            '## 関連Issue' \
            "Closes #${ISSUE_NUMBER}" \
            > pr-body.md

          PR_TITLE="feat: #${ISSUE_NUMBER} - ${ISSUE_TITLE}"

          # Create the PR (gh uses GH_TOKEN from env)
          gh pr create --title "$PR_TITLE" --body-file pr-body.md --base main --head "$BRANCH" --label "codex"

          # Get URL of the PR we just created (use gh pr view to query it)
          PR_URL=$(gh pr view --json url --jq '.url')
          echo "PR_URL=${PR_URL}" > pr-url.txt
          echo "Created PR: ${PR_URL}"

      - name: Add comment to issue
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.preflight.outputs.issue_number }}"
          BRANCH="codex/issue-${ISSUE_NUMBER}"
          
          # コメントをファイルに書き出し（heredocを避けてprintfで生成）
          : > issue-comment.md
          printf '%s\n' \
            '🤖 **自動実装が完了しました！**' \
            '' \
            'Codex CLIによる自動実装が完了し、プルリクエストが作成されました。' \
            '' \
            "- **ブランチ**: \`${BRANCH}\`" \
            '- **実装方針**: TDD + Tidy First原則' \
            '- **次のステップ**: PRレビューをお願いします' \
            '' \
            'レビュー後、問題なければマージしてください。' \
            > issue-comment.md
          
          gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md

      - name: Add comment to issue (no changes)
        if: steps.preflight.outputs.should_skip != 'true' && steps.codex_exec.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.preflight.outputs.issue_number }}"
          : > issue-comment.md
          printf '%s\n' \
            '🤖 自動実装を試行しましたが、リポジトリに変更は見つかりませんでした。' \
            '' \
            'Codex は変更を生成しなかったため、プルリクエストは作成されませんでした。' \
            > issue-comment.md
          gh issue comment ${ISSUE_NUMBER} --body-file issue-comment.md
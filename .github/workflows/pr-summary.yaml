name: PR summary with Codex

on:
  pull_request_target:
    types: [opened]

jobs:
  pr-summary-by-codex:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Switch to head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Codex CLI
        run: |
          npm install -g @openai/codex

      - name: Generate PR summary and comment
        run: |
          # PRæƒ…å ±ã‚’å–å¾—
          PR_NUMBER="${{ github.event.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          echo "Generating summary for PR #${PR_NUMBER}: ${PR_TITLE}"
          
          # PRã®å·®åˆ†ã‚’å–å¾—
          gh pr diff ${PR_NUMBER} > pr-diff.txt
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§ãã™ãã‚‹å ´åˆã¯è¦ç´„ï¼‰
          DIFF_SIZE=$(wc -c < pr-diff.txt)
          if [ $DIFF_SIZE -gt 50000 ]; then
            echo "Diff is large (${DIFF_SIZE} bytes), creating summary..."
            head -n 1000 pr-diff.txt > pr-diff-truncated.txt
            echo -e "\n\n... (å·®åˆ†ãŒå¤§ãã„ãŸã‚ã€æœ€åˆã®1000è¡Œã®ã¿è¡¨ç¤º)" >> pr-diff-truncated.txt
            mv pr-diff-truncated.txt pr-diff.txt
          fi

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ç”Ÿæˆï¼ˆprintfã§å®‰å…¨ã«å‡ºåŠ›ï¼‰
          : > summary-prompt.txt
          printf '%s\n' \
            'ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’åˆ†æã—ã€æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚' \
            '' \
            'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£' \
            'PR: ${PR_TITLE}' \
            '' \
            'è¦ç´„ã«å«ã‚ã‚‹ã¹ãé …ç›®:' \
            '1. ä¸»ãªå¤‰æ›´å†…å®¹ - ä½•ãŒå®Ÿè£…ãƒ»ä¿®æ­£ã•ã‚ŒãŸã‹' \
            '2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å½±éŸ¿ - ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€£æºã‚„è¨­è¨ˆã¸ã®å½±éŸ¿' \
            '3. ãƒ†ã‚¹ãƒˆ - è¿½åŠ ãƒ»ä¿®æ­£ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆå†…å®¹' \
            '4. APIå¤‰æ›´ - OpenAPIä»•æ§˜ã‚„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¤‰æ›´' \
            '5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ - èªè¨¼ãƒ»èªå¯ãƒ»RLSãƒãƒªã‚·ãƒ¼é–¢é€£ã®å¤‰æ›´' \
            '6. æ³¨æ„ç‚¹ - ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«ç‰¹ã«æ³¨æ„ã™ã¹ãç‚¹' \
            '' \
            'å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«: pr-diff.txt' \
            '' \
            'è¦ç´„ã‚’codex-summary.mdãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚' \
            > summary-prompt.txt

          # Codexã§è¦ç´„ç”Ÿæˆï¼ˆæ‰¿èªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãªã„ï¼‰
          codex --ask-for-approval never < summary-prompt.txt

          # è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f "codex-summary.md" ]; then
            echo "è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¦ç´„ã‚’ä½œæˆã—ã¾ã™ã€‚"
            : > codex-summary.md
            printf '%s\n' '## ğŸ“‹ PRè¦ç´„' >> codex-summary.md
            printf '%s\n' '' >> codex-summary.md
            printf '%s\n' "**PR**: ${PR_TITLE}" >> codex-summary.md
            printf '%s\n' '' >> codex-summary.md
            printf '%s\n' '### ğŸ¯ ä¸»ãªå¤‰æ›´å†…å®¹' >> codex-summary.md
            printf '%s\n' 'ã“ã®PRã¯è‡ªå‹•å®Ÿè£…ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªå¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯å·®åˆ†ã‚’ã”ç¢ºèªãã ã•ã„ã€‚' >> codex-summary.md
            printf '%s\n' '' >> codex-summary.md
            printf '%s\n' '### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ' >> codex-summary.md
            printf '%s\n' '- ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨TDDåŸå‰‡ã®éµå®ˆ' >> codex-summary.md
            printf '%s\n' '- OpenAPIä»•æ§˜ã¨ã®æ•´åˆæ€§' >> codex-summary.md
            printf '%s\n' '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª' >> codex-summary.md
            printf '%s\n' '- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã®å¦¥å½“æ€§' >> codex-summary.md
            printf '%s\n' '' >> codex-summary.md
            printf '%s\n' '---' >> codex-summary.md
            printf '%s\n' '*ã“ã®è¦ç´„ã¯Codex CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*' >> codex-summary.md
          fi

          # è¦ç´„ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh pr comment --body-file codex-summary.md "${PR_URL}"
          
          echo "PR summary posted successfully"

        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add review assignment
        run: |
          # TopTenFrontierãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æŠ€è¡“çš„ãªPRã®å ´åˆã€ç‰¹å®šã®ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.number }}"
          
          # ã‚µãƒ¼ãƒ“ã‚¹åã«åŸºã¥ã„ã¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          if echo "$PR_TITLE" | grep -qi "IndexConstituent"; then
            gh pr edit ${PR_NUMBER} --add-label "service:index-constituent"
          elif echo "$PR_TITLE" | grep -qi "MarketData"; then
            gh pr edit ${PR_NUMBER} --add-label "service:market-data"
          elif echo "$PR_TITLE" | grep -qi "Optimization"; then
            gh pr edit ${PR_NUMBER} --add-label "service:optimization"
          elif echo "$PR_TITLE" | grep -qi "Portfolio"; then
            gh pr edit ${PR_NUMBER} --add-label "service:portfolio"
          fi
          
          echo "Labels and review assignments updated"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
